{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - –î–µ—Ç—Å–∫–æ–µ –∫–∞—Ñ–µ "–†–∞–¥—É–≥–∞"{% endblock %}

{% block content %}
<h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–µ—Ç—Å–∫–æ–µ –∫–∞—Ñ–µ "–†–∞–¥—É–≥–∞"!</h1>
<div class="hero">
    <div class="hero-text">–ú–µ—Å—Ç–æ, –≥–¥–µ —Å–±—ã–≤–∞—é—Ç—Å—è –¥–µ—Ç—Å–∫–∏–µ –º–µ—á—Ç—ã!</div>
</div>
<p class="welcome-text">–ú—ã —Å–æ–∑–¥–∞–ª–∏ –æ—Å–æ–±–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ –¥–µ—Ç–∏ –º–æ–≥—É—Ç –≤–µ—Å–µ–ª–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤—Ä–µ–º—è, –∞ —Ä–æ–¥–∏—Ç–µ–ª–∏ - –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –∏ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –≤–∫—É—Å–Ω–æ–π –µ–¥–æ–π.</p>

<div class="rating-section">
    <h2>–û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à–µ –∫–∞—Ñ–µ</h2>
    <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –º–Ω–µ–Ω–∏–µ–º –æ –ø–æ—Å–µ—â–µ–Ω–∏–∏ –Ω–∞—à–µ–≥–æ –∫–∞—Ñ–µ</p>
    <a href="{% url 'homepage:rate_cafe' %}" class="rate-button">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</a>
    <a href="{% url 'homepage:reviews' %}" class="reviews-link">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã</a>
</div>

<div class="cards">
    <div class="card">
        <img src="https://avatars.mds.yandex.net/i?id=90cc0d5dfadf0ba957eeafd49ee6024a_l-8497314-images-thumbs&n=13" alt="–í–∫—É—Å–Ω–∞—è –µ–¥–∞" class="card-img">
        <div class="card-content">
            <h3>–í–∫—É—Å–Ω–∞—è –µ–¥–∞</h3>
            <p>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–µ—Ç—Å–∫–æ–µ –º–µ–Ω—é, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å —É—á–µ—Ç–æ–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π —Ä–∞—Å—Ç—É—â–µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–º–∞.</p>
        </div>
    </div>
    
    <div class="card">
        <img src="https://cdn.culture.ru/images/8f811004-c343-50b0-833f-ee4593088cad" alt="–ê–Ω–∏–º–∞—Ü–∏—è" class="card-img">
        <div class="card-content">
            <h3>–í–µ—Å–µ–ª—ã–µ –∞–Ω–∏–º–∞—Ç–æ—Ä—ã</h3>
            <p>–ù–∞—à–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∞–Ω–∏–º–∞—Ç–æ—Ä—ã –Ω–µ –¥–∞–¥—É—Ç —Å–∫—É—á–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–º—É —Ä–µ–±–µ–Ω–∫—É!</p>
        </div>
    </div>
    
    <div class="card">
        <img src="https://otadoya.ru/upload/iblock/689/rwgpboqahdtt999bgbax9kd2eis0stl3.jpg" alt="–ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞" class="card-img">
        <div class="card-content">
            <h3>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞</h3>
            <p>–ü—Ä–æ—Å—Ç–æ—Ä–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∏ –∏–≥—Ä—É—à–∫–∞–º–∏.</p>
        </div>
    </div>
</div>

<div class="booking-button-container">
    <button class="booking-button" onclick="openBookingForm()">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
</div>

<div id="bookingModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeBookingForm()">&times;</span>
        <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
        
        {% if not user.is_authenticated %}
        <div class="auth-alert">
            <p>–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="{% url 'homepage:login' %}" style="color: #4ecdc4;">–≤–æ–π—Ç–∏</a> –≤ —Å–∏—Å—Ç–µ–º—É.</p>
            <p>–ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞, <a href="{% url 'homepage:register' %}" style="color: #4ecdc4;">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>.</p>
        </div>
        {% else %}
        <form id="bookingForm">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="eventDate">–î–∞—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</label>
                <input type="date" id="eventDate" name="eventDate" required 
                       min="{{ today|date:'Y-m-d' }}" 
                       max="{{ max_date|date:'Y-m-d' }}">
                <div class="error-message" id="dateError"></div>
            </div>
            
            <div class="form-group">
                <label for="eventTime">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
                <input type="time" id="eventTime" name="eventTime" required 
                       min="10:00" max="20:00" step="1800">
                <div class="error-message" id="timeError"></div>
            </div>
            
            <div class="form-group">
                <label for="eventDuration">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á–∞—Å—ã):</label>
                <input type="number" id="eventDuration" name="eventDuration" 
                       min="1" max="8" value="2" required>
                <small>–ú–∏–Ω–∏–º—É–º 1 —á–∞—Å, –º–∞–∫—Å–∏–º—É–º 8 —á–∞—Å–æ–≤</small>
            </div>
            
            <div class="time-availability">
                <button type="button" onclick="checkBookingAvailability()" class="check-button">
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏
                </button>
                <div id="availabilityStatus"></div>
            </div>
            
            <div class="form-group">
                <label for="guestsCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π:</label>
                <input type="number" id="guestsCount" name="guestsCount" 
                       min="1" max="50" required>
            </div>
            
            <div class="form-group">
                <label for="eventType">–¢–∏–ø –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</label>
                <select id="eventType" name="eventType" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>
                    <option value="birthday">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</option>
                    <option value="holiday">–ü—Ä–∞–∑–¥–Ω–∏–∫</option>
                    <option value="graduation">–í—ã–ø—É—Å–∫–Ω–æ–π</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="services" value="animator" onchange="calculateBookingPrice()"> –ê–Ω–∏–º–∞—Ç–æ—Ä (+1000 —Ä—É–±)</label>
                    <label><input type="checkbox" name="services" value="cake" onchange="calculateBookingPrice()"> –¢–æ—Ä—Ç (+1500 —Ä—É–±)</label>
                    <label><input type="checkbox" name="services" value="decorations" onchange="calculateBookingPrice()"> –£–∫—Ä–∞—à–µ–Ω–∏–µ –∑–∞–ª–∞ (+2000 —Ä—É–±)</label>
                    <label><input type="checkbox" name="services" value="photographer" onchange="calculateBookingPrice()"> –§–æ—Ç–æ–≥—Ä–∞—Ñ (+2500 —Ä—É–±)</label>
                </div>
            </div>
            
            <div class="budget-preview">
                <h3>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç:</h3>
                <div class="budget-details">
                    <p>–ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span id="baseCost">5000</span> —Ä—É–±</p>
                    <p>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏: <span id="servicesCost">0</span> —Ä—É–±</p>
                    <p class="total">–ò—Ç–æ–≥–æ: <span id="totalCost">5000</span> —Ä—É–±</p>
                </div>
            </div>
            
            <div class="form-group">
                <label for="phone">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="tel" id="phone" name="phone" 
                       placeholder="+7 (XXX) XXX-XX-XX" 
                       required>
                <div class="error-message" id="phoneError"></div>
            </div>
            
            <div class="form-group">
                <label for="comments">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è:</label>
                <textarea id="comments" name="comments" rows="4"></textarea>
            </div>
            
            <button type="submit" class="submit-button" id="submitButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </form>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="successModal" class="modal" style="display: none;">
    <div class="modal-content success-modal-content">
        <span class="close" onclick="closeSuccessModal()">&times;</span>
        <div class="success-icon">üéâ</div>
        <h3 id="successTitle">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!</h3>
        <p id="successMessage">–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
        <div class="success-buttons">
            <!-- –í–∞—Ä–∏–∞–Ω—Ç —Å data-–∞—Ç—Ä–∏–±—É—Ç–æ–º - —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π -->
            <button class="success-button" 
                    data-profile-url="{% url 'homepage:profile' %}"
                    onclick="window.location.href=this.getAttribute('data-profile-url')">
                –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            </button>
            
            <button class="success-button secondary" onclick="closeSuccessModal()">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
.time-availability {
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.check-button {
    background: #4ecdc4;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
    width: 100%;
}

.check-button:hover {
    background: #3db8af;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
}

.check-button:active {
    transform: translateY(0);
}

#availabilityStatus {
    padding: 12px;
    border-radius: 6px;
    margin-top: 10px;
    font-weight: 600;
    text-align: center;
    display: none;
}

#availabilityStatus.available {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

#availabilityStatus.unavailable {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

#availabilityStatus.checking {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    display: block;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É—Å–ø–µ—Ö–∞ */
.success-modal-content {
    text-align: center;
    max-width: 500px;
    border: 4px solid #4ecdc4;
}

.success-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: bounce 0.6s ease-out;
}

@keyframes bounce {
    0% { transform: scale(0.3); }
    50% { transform: scale(1.1); }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); }
}

.success-modal-content h3 {
    color: #ff6b6b;
    margin-bottom: 15px;
    font-size: 24px;
}

.success-modal-content p {
    color: #555;
    font-size: 18px;
    line-height: 1.5;
    margin-bottom: 25px;
}

.success-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.success-button {
    background: #4ecdc4;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 180px;
}

.success-button:hover {
    background: #3db8af;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
}

.success-button.secondary {
    background: #ffd166;
    color: #333;
}

.success-button.secondary:hover {
    background: #ffc745;
    box-shadow: 0 4px 12px rgba(255, 209, 102, 0.3);
}

.auth-alert {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
}

.auth-alert p {
    margin: 10px 0;
    color: #856404;
}

.auth-alert a {
    color: #4ecdc4;
    font-weight: bold;
    text-decoration: none;
}

.auth-alert a:hover {
    text-decoration: underline;
}
</style>

<script>
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
const BOOKING_PRICES = {
    base_hourly: 2500, // —Ä—É–±/—á–∞—Å
    services: {
        animator: 1000,
        cake: 1500,
        decorations: 2000,
        photographer: 2500
    }
};

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function calculateBookingPrice() {
    const duration = parseInt(document.getElementById('eventDuration').value) || 2;
    const baseCost = BOOKING_PRICES.base_hourly * duration;
    
    let servicesCost = 0;
    document.querySelectorAll('input[name="services"]:checked').forEach(checkbox => {
        servicesCost += BOOKING_PRICES.services[checkbox.value] || 0;
    });
    
    document.getElementById('baseCost').textContent = baseCost;
    document.getElementById('servicesCost').textContent = servicesCost;
    document.getElementById('totalCost').textContent = baseCost + servicesCost;
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
async function checkBookingAvailability() {
    const eventDate = document.getElementById('eventDate').value;
    const eventTime = document.getElementById('eventTime').value;
    const eventDuration = document.getElementById('eventDuration').value;
    
    if (!eventDate || !eventTime) {
        showAvailabilityStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è', false);
        return;
    }
    
    const statusDiv = document.getElementById('availabilityStatus');
    statusDiv.className = 'checking';
    statusDiv.textContent = '‚åõ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å...';
    statusDiv.style.display = 'block';
    
    try {
        const response = await fetch('{% url "homepage:check_availability" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                eventDate: eventDate,
                eventTime: eventTime,
                eventDuration: eventDuration
            })
        });
        
        const data = await response.json();
        
        if (data.available) {
            showAvailabilityStatus('‚úÖ ' + (data.message || '–í—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–Ω–æ!'), true);
        } else {
            showAvailabilityStatus('‚ùå ' + (data.message || '–í—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ'), false);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:', error);
        showAvailabilityStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', false);
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
function showAvailabilityStatus(message, isAvailable) {
    const statusDiv = document.getElementById('availabilityStatus');
    statusDiv.textContent = message;
    statusDiv.className = isAvailable ? 'available' : 'unavailable';
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function validatePhone(phone) {
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
    const cleanPhone = phone.replace(/\D/g, '');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if (cleanPhone.length === 11 && (cleanPhone.startsWith('7') || cleanPhone.startsWith('8'))) {
        return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    if (cleanPhone.length >= 10 && cleanPhone.length <= 15) {
        return true;
    }
    
    return false;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    
    if (value.length > 0) {
        // –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä
        if (value.startsWith('7') || value.startsWith('8')) {
            if (value.length > 1) {
                let formatted = '+7 ';
                
                if (value.length > 1) formatted += '(' + value.substring(1, 4);
                if (value.length >= 4) formatted += ') ' + value.substring(4, 7);
                if (value.length >= 7) formatted += '-' + value.substring(7, 9);
                if (value.length >= 9) formatted += '-' + value.substring(9, 11);
                
                input.value = formatted;
            }
        } else {
            // –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä
            input.value = '+' + value.substring(0, 15);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É—Å–ø–µ—Ö–∞
function showSuccessModal(title, message) {
    document.getElementById('successTitle').textContent = title;
    document.getElementById('successMessage').textContent = message;
    document.getElementById('successModal').style.display = 'block';
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É—Å–ø–µ—Ö–∞
function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
async function submitBookingForm(event) {
    event.preventDefault();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
    if (!isAuthenticated) {
        alert('–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
        window.location.href = '{% url "homepage:login" %}';
        return;
    }
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
    clearErrors();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phone = document.getElementById('phone').value;
    if (!validatePhone(phone)) {
        showError('phone', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    const requiredFields = ['eventDate', 'eventTime', 'guestsCount', 'eventType'];
    let hasErrors = false;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value) {
            showError(fieldId, '–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
            hasErrors = true;
        }
    });
    
    if (hasErrors) return;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = true;
    submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    try {
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = {
            eventDate: document.getElementById('eventDate').value,
            eventTime: document.getElementById('eventTime').value,
            eventDuration: parseInt(document.getElementById('eventDuration').value) || 2,
            guestsCount: parseInt(document.getElementById('guestsCount').value),
            eventType: document.getElementById('eventType').value,
            phone: document.getElementById('phone').value,
            comments: document.getElementById('comments').value,
            services: Array.from(document.querySelectorAll('input[name="services"]:checked'))
                .map(checkbox => checkbox.value)
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch('{% url "homepage:create_booking" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            showSuccessModal('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!', data.message);
            closeBookingForm();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('bookingForm').reset();
            calculateBookingPrice();
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const firstError = errors[0];
                    showError(field, firstError.message);
                }
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        submitButton.disabled = false;
        submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showError(fieldId, message) {
    const errorElement = document.getElementById(fieldId + 'Error');
    const fieldElement = document.getElementById(fieldId);
    
    if (errorElement && fieldElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        fieldElement.style.borderColor = '#ff6b6b';
    }
}

function clearErrors() {
    const errorElements = document.querySelectorAll('.error-message');
    const fields = document.querySelectorAll('#bookingForm input, #bookingForm select, #bookingForm textarea');
    
    errorElements.forEach(element => {
        element.style.display = 'none';
    });
    
    fields.forEach(field => {
        field.style.borderColor = '#ffd166';
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('eventDate');
    if (dateInput) {
        if (!dateInput.getAttribute('min')) {
            dateInput.min = today;
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    const bookingForm = document.getElementById('bookingForm');
    const phoneInput = document.getElementById('phone');
    
    if (bookingForm) {
        bookingForm.addEventListener('submit', submitBookingForm);
    }
    
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            formatPhone(this);
            const errorElement = document.getElementById('phoneError');
            if (errorElement) {
                errorElement.style.display = 'none';
                this.style.borderColor = '#ffd166';
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    document.getElementById('eventDuration')?.addEventListener('change', calculateBookingPrice);
    document.getElementById('eventDuration')?.addEventListener('input', calculateBookingPrice);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    calculateBookingPrice();
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function openBookingForm() {
    document.getElementById('bookingModal').style.display = 'block';
    calculateBookingPrice();
}

function closeBookingForm() {
    document.getElementById('bookingModal').style.display = 'none';
    clearErrors();
    document.getElementById('availabilityStatus').style.display = 'none';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
window.onclick = function(event) {
    const bookingModal = document.getElementById('bookingModal');
    const successModal = document.getElementById('successModal');
    
    if (event.target == bookingModal) {
        closeBookingForm();
    }
    
    if (event.target == successModal) {
        closeSuccessModal();
    }
}
</script>
{% endblock %}