{% extends "base.html" %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ - –î–µ—Ç—Å–∫–æ–µ –∫–∞—Ñ–µ "–†–∞–¥—É–≥–∞"{% endblock %}

{% block content %}
<div class="cart-page">
    <h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>
    
    {% if cart_items %}
    <div class="cart-items">
        {% for item in cart_items %}
        <div class="cart-item">
            <div class="item-image">
                <img src="{{ item.product.image }}" alt="{{ item.product.title }}">
            </div>
            <div class="item-details">
                <h3>{{ item.product.title }}</h3>
                <p class="item-price">{{ item.product.price }} —Ä—É–±. √ó {{ item.quantity }} = {{ item.total }} —Ä—É–±.</p>
            </div>
            <div class="item-actions">
                <form method="post" action="{% url 'menu:update_cart' item.product.id %}" class="quantity-form">
                    {% csrf_token %}
                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="10" class="quantity-input">
                    <button type="submit" class="update-button">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </form>
                <a href="{% url 'menu:remove_from_cart' item.product.id %}" class="remove-button">–£–¥–∞–ª–∏—Ç—å</a>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    <div class="delivery-section" id="delivery_section" style="display: none;">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ</h3>
        <div class="delivery-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="delivery_city">–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
                    <select id="delivery_city" name="delivery_city" class="delivery-select">
                        {% for city in delivery_cities %}
                        <option value="{{ city.key }}" {% if delivery_city == city.key %}selected{% endif %}>
                            {{ city.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" id="distance_group" {% if delivery_city == 'tula' %}style="display: none;"{% endif %}>
                    <label for="delivery_distance">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º):</label>
                    <input type="number" id="delivery_distance" name="delivery_distance" 
                           value="{{ delivery_distance }}" min="0" max="500" class="distance-input">
                </div>
            </div>
            
            <div class="form-help">
                <small>–î–ª—è –≥–æ—Ä–æ–¥–æ–≤ –∫—Ä–æ–º–µ –¢—É–ª—ã —É–∫–∞–∂–∏—Ç–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –¢—É–ª—ã –¥–æ –≤–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞</small>
            </div>
            
            <button type="button" id="update_delivery" class="update-delivery-button">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É</button>
        </div>
        
        <div class="delivery-preview">
            <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> <span id="delivery_price">0</span> —Ä—É–±.</p>
        </div>
    </div>
    
    <div class="cart-summary">
        <div class="total-price">
            <h3>–¢–æ–≤–∞—Ä—ã: {{ total_price }} —Ä—É–±.</h3>
            <h3 id="delivery_summary_line" style="display: none;">–î–æ—Å—Ç–∞–≤–∫–∞: <span id="summary_delivery">0</span> —Ä—É–±.</h3>
            <h3>–ò—Ç–æ–≥–æ: <span id="final_total">{{ total_price }}</span> —Ä—É–±.</h3>
        </div>
        
        <div class="delivery-choice">
            <h3>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è:</h3>
            <div class="delivery-options">
                <label class="delivery-option">
                    <input type="radio" name="delivery_type" value="pickup" checked> 
                    –°–∞–º–æ–≤—ã–≤–æ–∑ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
                </label>
                <label class="delivery-option">
                    <input type="radio" name="delivery_type" value="delivery">
                    –î–æ—Å—Ç–∞–≤–∫–∞
                </label>
            </div>
        </div>
        
        <div class="cart-actions">
            <a href="{% url 'menu:clear_cart' %}" class="clear-cart-button">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</a>
            <a href="{% url 'menu:menu_list' %}" class="continue-shopping">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</a>
            {% if request.user.is_authenticated %}
                <button onclick="openOrderModal()" class="checkout-button">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            {% else %}
                <a href="{% url 'homepage:login' %}" class="checkout-button" style="background: #ff6b6b;">–í–æ–π–¥–∏—Ç–µ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞</a>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <div class="empty-icon">üõí</div>
        <h3>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
        <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –º–µ–Ω—é, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</p>
        <a href="{% url 'menu:menu_list' %}" class="back-to-menu">–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–µ–Ω—é</a>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeOrderModal()">&times;</span>
        <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        <form method="post" action="{% url 'menu:create_order' %}" id="orderForm">
            {% csrf_token %}
            
            <!-- –≠—Ç–∏ –ø–æ–ª—è –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            <input type="hidden" id="final_delivery_method" name="delivery_method" value="pickup">
            <input type="hidden" id="final_delivery_city" name="delivery_city" value="tula">
            <input type="hidden" id="final_delivery_distance" name="delivery_distance" value="0">
            <input type="hidden" id="final_delivery_price" name="delivery_price" value="0">
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ø–æ—Å–æ–±–µ –ø–æ–ª—É—á–µ–Ω–∏—è -->
            <div class="delivery-info-summary">
                <h3>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è: <span id="delivery_method_display">–°–∞–º–æ–≤—ã–≤–æ–∑</span></h3>
                <div id="order_delivery_details" style="display: none;">
                    <div class="delivery-details-grid">
                        <div class="delivery-detail">
                            <strong>–ì–æ—Ä–æ–¥:</strong> <span id="order_city_name">–¢—É–ª–∞</span>
                        </div>
                        <div class="delivery-detail" id="order_distance_detail" style="display: none;">
                            <strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> <span id="order_distance_value">0 –∫–º</span>
                        </div>
                        <div class="delivery-detail">
                            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> <span id="order_delivery_price_value">0 —Ä—É–±.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="payment_method">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
                <select id="payment_method" name="payment_method" required>
                    <option value="cash">–ù–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</option>
                    <option value="card">–ö–∞—Ä—Ç–æ–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</option>
                    <option value="online">–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="customer_name">–í–∞—à–µ –∏–º—è: *</label>
                <input type="text" id="customer_name" name="customer_name" required 
                    placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" minlength="2" maxlength="100">
            </div>

            <div class="form-group">
                <label for="customer_phone">–¢–µ–ª–µ—Ñ–æ–Ω: *</label>
                <input type="tel" id="customer_phone" name="customer_phone" required 
                    placeholder="+7 (999) 123-45-67" pattern="^\+7\s?\(?\d{3}\)?\s?\d{3}-?\d{2}-?\d{2}$">
                <small class="form-text">–§–æ—Ä–º–∞—Ç—ã: +7XXXXXXXXXX, 8XXXXXXXXXX, +7 (XXX) XXX-XX-XX</small>
            </div>

            <div class="form-group" id="address_field_group" style="display: none;">
                <label for="customer_address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: *</label>
                <textarea id="customer_address" name="customer_address" rows="3" 
                        placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞" minlength="10" maxlength="500"></textarea>
                <small class="form-text">–ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤</small>
            </div>
            
            <div class="order-summary">
                <h3>–í–∞—à –∑–∞–∫–∞–∑:</h3>
                {% for item in cart_items %}
                <p>{{ item.product.title }} √ó {{ item.quantity }} - {{ item.total }} —Ä—É–±.</p>
                {% endfor %}
                <p id="modal_delivery_line" style="display: none;">–î–æ—Å—Ç–∞–≤–∫–∞: <span id="modal_delivery_price">0</span> —Ä—É–±.</p>
                <p class="total">–ò—Ç–æ–≥–æ: <span id="modal_final_total">{{ total_price }}</span> —Ä—É–±.</p>
            </div>
            
            <button type="submit" class="submit-order-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </form>
    </div>
</div>

<script>
// –¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏
var currentDeliveryPrice = 0;

// –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function openOrderModal() {
    // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    updateOrderModal();
    
    // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('orderModal').style.display = 'block';
    
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
    setTimeout(function() {
        updateOrderModal();
    }, 100);
}

function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
}

function updateOrderModal() {
    var totalPrice = {{ total_price }};
    var deliveryMethod = getSelectedDeliveryMethod(); // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    document.getElementById('final_delivery_method').value = deliveryMethod;
    
    var finalTotal = totalPrice;
    var deliveryPrice = 0;
    
    if (deliveryMethod === 'delivery') {
        deliveryPrice = currentDeliveryPrice;
        finalTotal = totalPrice + deliveryPrice;
        
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
        var citySelect = document.getElementById('delivery_city');
        if (citySelect) {
            document.getElementById('final_delivery_city').value = citySelect.value;
        }
        var distanceInput = document.getElementById('delivery_distance');
        if (distanceInput) {
            document.getElementById('final_delivery_distance').value = distanceInput.value || 0;
        }
        document.getElementById('final_delivery_price').value = deliveryPrice;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    document.getElementById('modal_final_total').textContent = finalTotal.toFixed(2);
    
    var deliveryMethodDisplay = document.getElementById('delivery_method_display');
    var deliveryDetails = document.getElementById('order_delivery_details');
    var addressFieldGroup = document.getElementById('address_field_group');
    var modalDeliveryLine = document.getElementById('modal_delivery_line');
    
    if (deliveryMethod === 'delivery') {
        deliveryMethodDisplay.textContent = '–î–æ—Å—Ç–∞–≤–∫–∞';
        deliveryDetails.style.display = 'block';
        addressFieldGroup.style.display = 'block';
        modalDeliveryLine.style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
        var citySelect = document.getElementById('delivery_city');
        if (citySelect) {
            var cityName = citySelect.options[citySelect.selectedIndex].text.split(' (')[0];
            document.getElementById('order_city_name').textContent = cityName;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
            var distanceDetail = document.getElementById('order_distance_detail');
            var distanceInput = document.getElementById('delivery_distance');
            if (citySelect.value !== 'tula' && distanceInput && distanceInput.value > 0) {
                distanceDetail.style.display = 'block';
                document.getElementById('order_distance_value').textContent = distanceInput.value + ' –∫–º';
            } else {
                distanceDetail.style.display = 'none';
            }
        }
        
        document.getElementById('modal_delivery_price').textContent = deliveryPrice;
        document.getElementById('order_delivery_price_value').textContent = deliveryPrice + ' —Ä—É–±.';
    } else {
        deliveryMethodDisplay.textContent = '–°–∞–º–æ–≤—ã–≤–æ–∑';
        deliveryDetails.style.display = 'none';
        addressFieldGroup.style.display = 'none';
        modalDeliveryLine.style.display = 'none';
        document.getElementById('final_delivery_price').value = 0;
    }
}

function getSelectedDeliveryMethod() {
    var pickupRadio = document.querySelector('input[name="delivery_type"][value="pickup"]');
    if (pickupRadio && pickupRadio.checked) {
        return 'pickup';
    }
    return 'delivery';
}

function updateTotalPrice() {
    var totalPrice = {{ total_price }};
    var deliveryMethod = getSelectedDeliveryMethod();
    var finalTotal = totalPrice;
    
    if (deliveryMethod === 'delivery') {
        finalTotal = totalPrice + currentDeliveryPrice;
        document.getElementById('delivery_summary_line').style.display = 'block';
        document.getElementById('summary_delivery').textContent = currentDeliveryPrice;
    } else {
        document.getElementById('delivery_summary_line').style.display = 'none';
        currentDeliveryPrice = 0;
    }
    
    document.getElementById('final_total').textContent = finalTotal.toFixed(2);
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
    document.getElementById('final_delivery_method').value = deliveryMethod;
    updateOrderModal();
}

// –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
    var deliveryRadios = document.querySelectorAll('input[name="delivery_type"]');
    deliveryRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            var deliverySection = document.getElementById('delivery_section');
            if (this.value === 'delivery') {
                deliverySection.style.display = 'block';
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ—Å—Ç–∞–≤–∫—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É
                var updateBtn = document.getElementById('update_delivery');
                if (updateBtn) {
                    updateBtn.click();
                }
            } else {
                deliverySection.style.display = 'none';
                currentDeliveryPrice = 0;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            updateTotalPrice();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            updateOrderModal();
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≥–æ—Ä–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
    var deliveryCitySelect = document.getElementById('delivery_city');
    if (deliveryCitySelect) {
        deliveryCitySelect.addEventListener('change', function() {
            var distanceGroup = document.getElementById('distance_group');
            var distanceInput = document.getElementById('delivery_distance');
            
            if (this.value === 'tula') {
                distanceGroup.style.display = 'none';
                if (distanceInput) {
                    distanceInput.value = 0;
                }
            } else {
                distanceGroup.style.display = 'block';
            }
            updateOrderModal();
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
    var distanceInput = document.getElementById('delivery_distance');
    if (distanceInput) {
        distanceInput.addEventListener('input', function() {
            updateOrderModal();
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
    var updateDeliveryBtn = document.getElementById('update_delivery');
    if (updateDeliveryBtn) {
        updateDeliveryBtn.addEventListener('click', function() {
            var citySelect = document.getElementById('delivery_city');
            var distanceInput = document.getElementById('delivery_distance');
            
            if (citySelect && distanceInput) {
                var city = citySelect.value;
                var distance = distanceInput.value;
                
                // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                var formData = new FormData();
                formData.append('city', city);
                formData.append('distance', distance);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '{% url "menu:update_delivery_info" %}', true);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            currentDeliveryPrice = parseFloat(data.delivery_price);
                            document.getElementById('delivery_price').textContent = currentDeliveryPrice;
                            updateTotalPrice();
                        }
                    }
                };
                
                xhr.send(formData);
            }
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function(event) {
        var modal = document.getElementById('orderModal');
        if (event.target === modal) {
            closeOrderModal();
        }
    };

    // –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–Ω–æ–ø–∫–∏ "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
    document.querySelectorAll('.checkout-button, .checkout-button[onclick*="openOrderModal"]').forEach(function(button) {
        button.addEventListener('click', function(e) {
            if (this.classList.contains('checkout-button') && !this.href) {
                e.preventDefault();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏
                var deliveryMethod = getSelectedDeliveryMethod();
                
                if (deliveryMethod === 'delivery') {
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏, –Ω–æ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å
                    if (currentDeliveryPrice === 0) {
                        var updateBtn = document.getElementById('update_delivery');
                        if (updateBtn) {
                            updateBtn.click();
                        }
                    }
                }
                
                openOrderModal();
            }
        });
    });

    document.getElementById('orderForm').addEventListener('submit', function(e) {
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        var deliveryMethod = document.getElementById('final_delivery_method').value;
        
        if (deliveryMethod === 'delivery') {
            var deliveryCity = document.getElementById('final_delivery_city').value;
            var deliveryPrice = parseFloat(document.getElementById('final_delivery_price').value);
            
            if (!deliveryCity || deliveryCity.trim() === '') {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏');
                e.preventDefault();
                return false;
            }
            
            if (isNaN(deliveryPrice) || deliveryPrice <= 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏');
                e.preventDefault();
                return false;
            }
        }
        
        // –û—Å—Ç–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è...
        if (!validateOrderForm()) {
            e.preventDefault();
            return false;
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function validatePhone(phone) {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
    var cleaned = phone.replace(/\D/g, '');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
    if (cleaned.length < 10 || cleaned.length > 11) {
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
    if (cleaned.length === 11) {
        if (cleaned[0] !== '7' && cleaned[0] !== '8') {
            return false;
        }
        // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        cleaned = cleaned.substring(1);
    }
    
    // –¢–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 10 —Ü–∏—Ñ—Ä
    if (cleaned.length !== 10) {
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–ø–µ—Ä–≤—ã–µ 3 —Ü–∏—Ñ—Ä—ã)
    var operatorCode = cleaned.substring(0, 3);
    var validCodes = ['900','901','902','903','904','905','906','907','908','909',
                      '910','911','912','913','914','915','916','917','918','919',
                      '920','921','922','923','924','925','926','927','928','929',
                      '930','931','932','933','934','935','936','937','938','939',
                      '940','941','942','943','944','945','946','947','948','949',
                      '950','951','952','953','954','955','956','957','958','959',
                      '960','961','962','963','964','965','966','967','968','969',
                      '970','971','972','973','974','975','976','977','978','979',
                      '980','981','982','983','984','985','986','987','988','989',
                      '990','991','992','993','994','995','996','997','998','999'];
    
    return validCodes.includes(operatorCode);
}

// –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function formatPhoneInput(input, event) {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–µ–∑ –º–∞—Å–∫–∏
    let value = input.value.replace(/\D/g, '');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –∫–ª–∞–≤–∏—à–∞ –±—ã–ª–∞ –Ω–∞–∂–∞—Ç–∞
    const key = event.key;
    
    // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ Backspace –∏–ª–∏ Delete, —Ä–∞–∑—Ä–µ—à–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
    if (event.key === 'Backspace' || event.key === 'Delete') {
        return; // –ù–µ –º–µ—à–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é —É–¥–∞–ª–µ–Ω–∏—è
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É (11 —Ü–∏—Ñ—Ä: +7 + 10 —Ü–∏—Ñ—Ä)
    if (value.length > 11) {
        event.preventDefault();
        return;
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞
    setTimeout(() => {
        value = input.value.replace(/\D/g, '');
        
        if (value.length > 0) {
            let formatted = '';
            
            if (value.length <= 1) {
                formatted = '+7';
            } else if (value.length <= 4) {
                formatted = '+7 (' + value.substring(1, 4);
            } else if (value.length <= 7) {
                formatted = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7);
            } else if (value.length <= 9) {
                formatted = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7, 9);
            } else {
                formatted = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7, 9) + '-' + value.substring(9, 11);
            }
            
            input.value = formatted;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
            input.setSelectionRange(formatted.length, formatted.length);
        }
    }, 0);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à
function handlePhoneKeydown(event) {
    const input = event.target;
    const key = event.key;
    
    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, Backspace, Delete, Tab –∏ —Å—Ç—Ä–µ–ª–∫–∏
    if (!/[\d]|Backspace|Delete|Tab|ArrowLeft|ArrowRight|ArrowUp|ArrowDown/.test(key)) {
        event.preventDefault();
        return;
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
    const currentValue = input.value.replace(/\D/g, '');
    if (currentValue.length >= 11 && /\d/.test(key)) {
        event.preventDefault();
        return;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å—Ç–∞–≤–∫–∏
function handlePhonePaste(event) {
    event.preventDefault();
    const pastedData = (event.clipboardData || window.clipboardData).getData('text');
    const numbersOnly = pastedData.replace(/\D/g, '');
    
    if (numbersOnly.length > 11) {
        return; // –ù–µ –≤—Å—Ç–∞–≤–ª—è–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
    }
    
    const input = event.target;
    const currentValue = input.value.replace(/\D/g, '');
    
    // –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ +7 —É–∂–µ –µ—Å—Ç—å –≤ –º–∞—Å–∫–µ
    const newValue = currentValue + numbersOnly;
    const limitedValue = newValue.substring(0, 11);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (limitedValue.length > 0) {
        let formatted = '';
        
        if (limitedValue.length <= 1) {
            formatted = '+7';
        } else if (limitedValue.length <= 4) {
            formatted = '+7 (' + limitedValue.substring(1, 4);
        } else if (limitedValue.length <= 7) {
            formatted = '+7 (' + limitedValue.substring(1, 4) + ') ' + limitedValue.substring(4, 7);
        } else if (limitedValue.length <= 9) {
            formatted = '+7 (' + limitedValue.substring(1, 4) + ') ' + limitedValue.substring(4, 7) + '-' + limitedValue.substring(7, 9);
        } else {
            formatted = '+7 (' + limitedValue.substring(1, 4) + ') ' + limitedValue.substring(4, 7) + '-' + limitedValue.substring(7, 9) + '-' + limitedValue.substring(9, 11);
        }
        
        input.value = formatted;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
        input.setSelectionRange(formatted.length, formatted.length);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
function validateOrderForm() {
    var phoneInput = document.getElementById('customer_phone');
    var nameInput = document.getElementById('customer_name');
    var addressInput = document.getElementById('customer_address');
    var deliveryMethod = getSelectedDeliveryMethod();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
    if (!nameInput.value.trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
        nameInput.focus();
        return false;
    }
    
    if (nameInput.value.trim().length < 2) {
        alert('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
        nameInput.focus();
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if (!phoneInput.value.trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        phoneInput.focus();
        return false;
    }
    
    if (!validatePhone(phoneInput.value)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n–§–æ—Ä–º–∞—Ç—ã: +7XXXXXXXXXX, 8XXXXXXXXXX');
        phoneInput.focus();
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏
    if (deliveryMethod === 'delivery') {
        if (!addressInput.value.trim()) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏');
            addressInput.focus();
            return false;
        }
        
        if (addressInput.value.trim().length < 10) {
            alert('–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤');
            addressInput.focus();
            return false;
        }
    }
    
    return true;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    var phoneInput = document.getElementById('customer_phone');
    if (phoneInput) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–ø—É—Å—Ç–∞—è –º–∞—Å–∫–∞)
        phoneInput.value = '+7';
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        phoneInput.addEventListener('keydown', handlePhoneKeydown);
        phoneInput.addEventListener('input', function(event) {
            formatPhoneInput(this, event);
        });
        phoneInput.addEventListener('paste', handlePhonePaste);
        
        // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ - —Å—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ +7
        phoneInput.addEventListener('focus', function() {
            if (this.value === '+7') {
                this.setSelectionRange(3, 3);
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        phoneInput.addEventListener('blur', function() {
            const value = this.value.replace(/\D/g, '');
            
            if (value.length < 11) {
                this.style.borderColor = '#ef476f';
                let hint = document.getElementById('phone_hint');
                if (!hint) {
                    hint = document.createElement('div');
                    hint.id = 'phone_hint';
                    hint.style.color = '#ef476f';
                    hint.style.fontSize = '12px';
                    hint.style.marginTop = '5px';
                    hint.innerHTML = '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +7';
                    this.parentNode.appendChild(hint);
                }
            } else {
                this.style.borderColor = '#06d6a0';
                const hint = document.getElementById('phone_hint');
                if (hint) {
                    hint.remove();
                }
            }
        });
    }

    // –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é validatePhone –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
    function validatePhone(phone) {
        const cleaned = phone.replace(/\D/g, '');
        return cleaned.length === 11 && cleaned.startsWith('7');
    }
    
    // –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é validateOrderForm
    function validateOrderForm() {
        var phoneInput = document.getElementById('customer_phone');
        var nameInput = document.getElementById('customer_name');
        var addressInput = document.getElementById('customer_address');
        var deliveryMethod = getSelectedDeliveryMethod();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if (!phoneInput.value.trim()) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            phoneInput.focus();
            return false;
        }

        const phoneValue = phoneInput.value.replace(/\D/g, '');
        if (phoneValue.length !== 11 || !phoneValue.startsWith('7')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n–§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX');
            phoneInput.focus();
            phoneInput.setSelectionRange(0, phoneInput.value.length);
            return false;
        }

        return true;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    var orderForm = document.querySelector('#orderModal form');
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            if (!validateOrderForm()) {
                e.preventDefault();
                return false;
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
    var deliveryRadios = document.querySelectorAll('input[name="delivery_type"]');
    deliveryRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            var addressField = document.getElementById('address_field_group');
            if (this.value === 'delivery') {
                addressField.style.display = 'block';
                document.getElementById('customer_address').setAttribute('required', 'required');
            } else {
                addressField.style.display = 'none';
                document.getElementById('customer_address').removeAttribute('required');
            }
        });
    });
});
</script>

<style>
.delivery-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin: 20px 0;
}

.delivery-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    align-items: end;
}

.form-help {
    margin-top: -10px;
}

.form-help small {
    color: #6c757d;
    font-size: 0.85em;
}

.update-delivery-button {
    background: #4ecdc4;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    height: fit-content;
    width: fit-content;
}

.delivery-preview {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #4ecdc4;
}

.delivery-choice {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin: 20px 0;
}

.delivery-options {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.delivery-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    border: 2px solid #ffd166;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.delivery-option:hover {
    background: #fff9e6;
}

.delivery-option input[type="radio"] {
    margin: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ—Å—Ç–∞–≤–∫–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
.delivery-info-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #4ecdc4;
}

.delivery-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}

.delivery-detail {
    padding: 8px;
    background: white;
    border-radius: 5px;
    border: 1px solid #e9ecef;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .delivery-options {
        flex-direction: column;
    }
    
    .delivery-details-grid {
        grid-template-columns: 1fr;
    }
    
    .update-delivery-button {
        width: 100%;
    }
}

input:invalid, textarea:invalid {
    border-color: #ef476f;
}

input:valid, textarea:valid {
    border-color: #06d6a0;
}

.form-text {
    color: #6c757d;
    font-size: 0.85em;
    margin-top: 5px;
}

.required-label::after {
    content: " *";
    color: #ef476f;
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
    #orderModal .modal-content {
        width: 95%;
        margin: 5% auto;
        padding: 20px;
    }
}

/* –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å */
#customer_phone {
    padding-left: 15px;
    letter-spacing: 1px;
}

#customer_phone::placeholder {
    color: #999;
    opacity: 0.7;
}

#customer_phone:focus {
    border-color: #4ecdc4;
    box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
}

.phone-input-container {
    position: relative;
}

.phone-prefix {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    pointer-events: none;
}

.phone-input-with-prefix {
    padding-left: 35px;
}
</style>
{% endblock %}